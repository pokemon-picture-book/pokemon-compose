version: '3'

services:
  swagger-editor:
    image: swaggerapi/swagger-editor
    container_name: "swagger-editor"
    ports:
      - "8001:8080"

  swagger-ui:
    image: swaggerapi/swagger-ui
    container_name: "swagger-ui"
    depends_on:
      - swagger-nginx
    ports:
      - "8002:8080"
    volumes:
      - ../pokemon-api/swagger/openapi.yaml:/openapi.yaml
    environment:
      SWAGGER_JSON: /openapi.yaml
      # API_URL: ""

  swagger-nginx:
    image: nginx:mainline-alpine
    container_name: "swagger-nginx"
    depends_on:
      - pokemon-api
    ports:
      - "8003:8081"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      swagger_link:
        aliases:
          - local.swagger.api

  sonarqube-db:
    image: postgres:9.6
    container_name: 'sonarqube-db'
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=sonar
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
      - TZ=Japan
    volumes:
      - /var/lib/postgresql/data

  sonarqube:
    image: sonarqube:7.1
    depends_on:
      - sonarqube-db
    container_name: 'sonarqube'
    ports:
      - "9000:9000"
    environment:
      - sonar.jdbc.url=jdbc:postgresql://sonarqube-db:5432/sonar
    volumes:
      - /opt/sonarqube/conf
      - /opt/sonarqube/data
      - /opt/sonarqube/extensions

  pokemon-db:
    image: mysql:5.7
    container_name: pokemon-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: pokemon
      MYSQL_USER: pokemon
      MYSQL_PASSWORD: pokemon
      TZ: 'Asia/Tokyo'
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - ./data/mysql/data:/var/lib/mysql
      - ./data/mysql/my.cnf:/etc/mysql/conf.d/my.cnf
      - ./data/mysql/sql:/docker-entrypoint-initdb.d
    ports:
      - 3307:3306

  pokemon-api:
    tty: true
    networks:
      swagger_link:
        aliases:
          - local.swagger.apisprout
    build: ../pokemon-api
    depends_on:
      - pokemon-db
      - sonarqube-db
      - sonarqube
    container_name: 'pokemon-api'
    volumes:
      - ../pokemon-api/:/usr/app/
      - /usr/app/node_modules
    environment:
      TZ: 'Asia/Tokyo'
      HOST: '0.0.0.0'
      PORT: '3001'
      DB_CONFIG: |
        {
          "host": "host.docker.internal",
          "database": "pokemon",
          "username": "pokemon",
          "password": "pokemon",
          "port": 3307
        }
    ports:
      - 3001:3001
    entrypoint: ./docker-entrypoint/dev.sh

  pokemon-client:
    tty: true
    build:
      context: ../pokemon-client
      dockerfile: Dev.Dockerfile
    volumes:
      - ../pokemon-client/:/usr/app/
      - /usr/app/node_modules
    environment:
      NODE_ENV: development
      API_BASE_URL: 'http://localhost:3001/'
    ports:
      - '8080:8080'
    entrypoint: ./scripts/dev.sh

networks:
  swagger_link:
    external: true
